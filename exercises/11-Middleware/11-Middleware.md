[To previous lesson](/exercises/10-Static_files/10-Static_files.md)

# 11 - Middleware

> **Learning goal:** Understand how middleware like [Morgan](https://github.com/expressjs/morgan) and Body Parser manipulate incoming requests.

In this exercise, we want to create a request logging middleware that allows us to print details about incoming requests to the command line. We will base the format loosely on the [logs generated by Apache servers](http://ossec-docs.readthedocs.io/en/latest/log_samples/apache/apache.html). What we want to print to the command line will be in the format 

```
ip_address [DD/Month/YYYY:HH:MM:SS AM?PM] HTTP_VERB - path
```

For example

```
::1 [24/Jan/2017:9:53:02 PM] GET - /
```

#### `logger.js`

This file will be used to perform all of the loggin operations for our middleware. As you can see, there is already a function in the file:

```js
function generateMonthName(monthNumber) {
	const months = [
		'Jan',
		'Feb',
		'Mar',
		'Apr',
		'May',
		'Jun',
		'Jul',
		'Aug',
		'Sep',
		'Oct',
		'Nov',
		'Dec'
	];

	return months[monthNumber];
}
```

This function will be supplied a month number and be given a three letter month name.

Now that we know what is happening in the file, we can create our `logger` function (which will be what we export from the module). This function looks very similar to the functions that we've passed to `app.use`, `app.get`, `app.post`, etc. in the previous exercises, except that it has a third argument, `next`, which is a function that, when called, executes to the next middleware or route.

```js
module.exports = function logger(req, res, next) {
    // log stuff here
}
```

The first part of our log is the IP address of the request. We can get this from `req.ip`.

```js
const ip = req.ip;
```

Next, we want to generate a string that has the current date and time. We can start by initializing a new `Date` object:

```js
const today = new Date();
```

We can get the day from `today` using `today.getDate()`. We always want this date to be two numbers, so if the date is less than 10 we want to add a 0 to the beginning of the date:

```js
const day = today.getDate() < 10 ? `0${today.getDate()}` : today.getDate();
```

We can use `today.getMonth()` to get a number between 0 and 11, which we can pass to `generateMonthName` to get the three letter month name:

```js
const month = generateMonthName(today.getMonth());
```

Next, we get the year using `today.getFullYear()`:

```js
const year = today.getFullYear();
```

We now have our date string:

```js
const date = `${day}/${month}/${year}`;
```

We can get the time string by using `today.toLocaleTimeString()`:

```js
const time = today.toLocaleTimeString();
```

We can then combine date and time to get our datetime string:

```js
const datetime = `[${date}:${time}]`;
```

We then want to get the HTTP method, or verb, that the request used:

```js
const method = req.method;
```

The last piece of information that we need is the path that the request was sent to:

```js
const url = req.originalUrl;
```

We then want to log all of our information to the console:

```js
console.log(`${ip} ${datetime} ${method} - ${url}`);
```

We finish our middleware by calling:

```js
next();
```

>**NOTE:** If you have a middleware function (i.e. a function that has the `next` parameter, rather than just `req` and `res`), you must call `next()` or the middleware function will never end and your sever will be stuck in that function.

#### `index.js`

Now that we've completed our `logger.js` file, we need to complete `index.js`. We first need to import the `logger` module:

```js
const logger = require('./logger');
```

Finally, we have to tell the app to use it:

```js 
app.use(logger);
```

Now if we start the server and make a request to `/` you will see all of the requests that your browser makes when loading the webpage.

[To previous lesson](/exercises/12-Consuming_APIs/12-Consuming_APIs.md)
